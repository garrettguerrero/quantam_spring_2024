import{findWrapping as e,ReplaceAroundStep as t,canSplit as n,liftTarget as r,canJoin as o}from"prosemirror-transform";import{NodeRange as l,Fragment as i,Slice as d}from"prosemirror-model";import{Selection as s}from"prosemirror-state";const f=["ol",0],p=["ul",0],a=["li",0];const u={attrs:{order:{default:1}},parseDOM:[{tag:"ol",getAttrs(e){return{order:e.hasAttribute("start")?+e.getAttribute("start"):1}}}],toDOM(e){return 1==e.attrs.order?f:["ol",{start:e.attrs.order},0]}};const c={parseDOM:[{tag:"ul"}],toDOM(){return p}};const m={parseDOM:[{tag:"li"}],toDOM(){return a},defining:true};function add(e,t){let n={};for(let t in e)n[t]=e[t];for(let e in t)n[e]=t[e];return n}function addListNodes(e,t,n){return e.append({ordered_list:add(u,{content:"list_item+",group:n}),bullet_list:add(c,{content:"list_item+",group:n}),list_item:add(m,{content:t})})}function wrapInList(t,n=null){return function(r,o){let{$from:i,$to:d}=r.selection;let s=i.blockRange(d),f=false,p=s;if(!s)return false;if(s.depth>=2&&i.node(s.depth-1).type.compatibleContent(t)&&0==s.startIndex){if(0==i.index(s.depth-1))return false;let e=r.doc.resolve(s.start-2);p=new l(e,e,s.depth);s.endIndex<s.parent.childCount&&(s=new l(i,r.doc.resolve(d.end(s.depth)),s.depth));f=true}let a=e(p,t,n,s);if(!a)return false;o&&o(doWrapInList(r.tr,s,a,f,t).scrollIntoView());return true}}function doWrapInList(e,r,o,l,s){let f=i.empty;for(let e=o.length-1;e>=0;e--)f=i.from(o[e].type.create(o[e].attrs,f));e.step(new t(r.start-(l?2:0),r.end,r.start,r.end,new d(f,0,0),o.length,true));let p=0;for(let e=0;e<o.length;e++)o[e].type==s&&(p=e+1);let a=o.length-p;let u=r.start+o.length-(l?2:0),c=r.parent;for(let t=r.startIndex,o=r.endIndex,l=true;t<o;t++,l=false){if(!l&&n(e.doc,u,a)){e.split(u,a);u+=2*a}u+=c.child(t).nodeSize}return e}function splitListItem(e,t){return function(r,o){let{$from:l,$to:f,node:p}=r.selection;if(p&&p.isBlock||l.depth<2||!l.sameParent(f))return false;let a=l.node(-1);if(a.type!=e)return false;if(0==l.parent.content.size&&l.node(-1).childCount==l.indexAfter(-1)){if(3==l.depth||l.node(-3).type!=e||l.index(-2)!=l.node(-2).childCount-1)return false;if(o){let t=i.empty;let n=l.index(-1)?1:l.index(-2)?2:3;for(let e=l.depth-n;e>=l.depth-3;e--)t=i.from(l.node(e).copy(t));let f=l.indexAfter(-1)<l.node(-2).childCount?1:l.indexAfter(-2)<l.node(-3).childCount?2:3;t=t.append(i.from(e.createAndFill()));let p=l.before(l.depth-(n-1));let a=r.tr.replace(p,l.after(-f),new d(t,4-n,0));let u=-1;a.doc.nodesBetween(p,a.doc.content.size,((e,t)=>{if(u>-1)return false;e.isTextblock&&0==e.content.size&&(u=t+1)}));u>-1&&a.setSelection(s.near(a.doc.resolve(u)));o(a.scrollIntoView())}return true}let u=f.pos==l.end()?a.contentMatchAt(0).defaultType:null;let c=r.tr.delete(l.pos,f.pos);let m=u?[t?{type:e,attrs:t}:null,{type:u}]:void 0;if(!n(c.doc,l.pos,2,m))return false;o&&o(c.split(l.pos,2,m).scrollIntoView());return true}}function liftListItem(e){return function(t,n){let{$from:r,$to:o}=t.selection;let l=r.blockRange(o,(t=>t.childCount>0&&t.firstChild.type==e));return!!l&&(!n||(r.node(l.depth-1).type==e?liftToOuterList(t,n,e,l):liftOutOfList(t,n,l)))}}function liftToOuterList(e,n,s,f){let p=e.tr,a=f.end,u=f.$to.end(f.depth);if(a<u){p.step(new t(a-1,u,a,u,new d(i.from(s.create(null,f.parent.copy())),1,0),1,true));f=new l(p.doc.resolve(f.$from.pos),p.doc.resolve(u),f.depth)}const c=r(f);if(null==c)return false;p.lift(f,c);let m=p.mapping.map(a,-1)-1;o(p.doc,m)&&p.join(m);n(p.scrollIntoView());return true}function liftOutOfList(e,n,r){let o=e.tr,l=r.parent;for(let e=r.end,t=r.endIndex-1,n=r.startIndex;t>n;t--){e-=l.child(t).nodeSize;o.delete(e-1,e+1)}let s=o.doc.resolve(r.start),f=s.nodeAfter;if(o.mapping.map(r.end)!=r.start+s.nodeAfter.nodeSize)return false;let p=0==r.startIndex,a=r.endIndex==l.childCount;let u=s.node(-1),c=s.index(-1);if(!u.canReplace(c+(p?0:1),c+1,f.content.append(a?i.empty:i.from(l))))return false;let m=s.pos,h=m+f.nodeSize;o.step(new t(m-(p?1:0),h+(a?1:0),m+1,h-1,new d((p?i.empty:i.from(l.copy(i.empty))).append(a?i.empty:i.from(l.copy(i.empty))),p?0:1,a?0:1),p?0:1));n(o.scrollIntoView());return true}function sinkListItem(e){return function(n,r){let{$from:o,$to:l}=n.selection;let s=o.blockRange(l,(t=>t.childCount>0&&t.firstChild.type==e));if(!s)return false;let f=s.startIndex;if(0==f)return false;let p=s.parent,a=p.child(f-1);if(a.type!=e)return false;if(r){let o=a.lastChild&&a.lastChild.type==p.type;let l=i.from(o?e.create():null);let f=new d(i.from(e.create(null,i.from(p.type.create(null,l)))),o?3:1,0);let u=s.start,c=s.end;r(n.tr.step(new t(u-(o?3:1),c,u,c,f,1,true)).scrollIntoView())}return true}}export{addListNodes,c as bulletList,liftListItem,m as listItem,u as orderedList,sinkListItem,splitListItem,wrapInList};

