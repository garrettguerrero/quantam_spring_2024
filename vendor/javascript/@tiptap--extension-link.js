import{combineTransactionSteps as t,getChangedRanges as e,findChildrenInRange as n,getMarksBetween as r,getAttributes as o,mergeAttributes as i,markPasteRule as a,Mark as s}from"@tiptap/core";import{find as l,registerCustomProtocol as u,reset as d}from"linkifyjs";import{PluginKey as p,Plugin as c}from"@tiptap/pm/state";function autolink(o){return new c({key:new p("autolink"),appendTransaction:(i,a,s)=>{const u=i.some((t=>t.docChanged))&&!a.doc.eq(s.doc);const d=i.some((t=>t.getMeta("preventAutolink")));if(!u||d)return;const{tr:p}=s;const c=t(a.doc,[...i]);const f=e(c);f.forEach((({newRange:t})=>{const e=n(s.doc,t,(t=>t.isTextblock));let i;let a;if(e.length>1){i=e[0];a=s.doc.textBetween(i.pos,i.pos+i.node.nodeSize,void 0," ")}else if(e.length&&s.doc.textBetween(t.from,t.to," "," ").endsWith(" ")){i=e[0];a=s.doc.textBetween(i.pos,t.to,void 0," ")}if(i&&a){const t=a.split(" ").filter((t=>t!==""));if(t.length<=0)return false;const e=t[t.length-1];const n=i.pos+a.lastIndexOf(e);if(!e)return false;l(e).filter((t=>t.isLink)).map((t=>({...t,from:n+t.start+1,to:n+t.end+1}))).filter((t=>!s.schema.marks.code||!s.doc.rangeHasMark(t.from,t.to,s.schema.marks.code))).filter((t=>!o.validate||o.validate(t.value))).forEach((t=>{r(t.from,t.to,s.doc).some((t=>t.mark.type===o.type))||p.addMark(t.from,t.to,o.type.create({href:t.href}))}))}}));return p.steps.length?p:void 0}})}function clickHandler(t){return new c({key:new p("handleClickLink"),props:{handleClick:(e,n,r)=>{var i,a;if(r.button!==0)return false;let s=r.target;const l=[];while(s.nodeName!=="DIV"){l.push(s);s=s.parentNode}if(!l.find((t=>t.nodeName==="A")))return false;const u=o(e.state,t.type.name);const d=r.target;const p=(i=d===null||d===void 0?void 0:d.href)!==null&&i!==void 0?i:u.href;const c=(a=d===null||d===void 0?void 0:d.target)!==null&&a!==void 0?a:u.target;if(d&&p){window.open(p,c);return true}return false}}})}function pasteHandler(t){return new c({key:new p("handlePasteLink"),props:{handlePaste:(e,n,r)=>{const{state:o}=e;const{selection:i}=o;const{empty:a}=i;if(a)return false;let s="";r.content.forEach((t=>{s+=t.textContent}));const u=l(s).find((t=>t.isLink&&t.value===s));if(!s||!u)return false;t.editor.commands.setMark(t.type,{href:u.href});return true}}})}const f=/https?:\/\/(?:www\.)?[-a-zA-Z0-9@:%._+~#=]{1,256}\.[a-zA-Z]{2,}\b(?:[-a-zA-Z0-9@:%._+~#=?!&/]*)(?:[-a-zA-Z0-9@:%._+~#=?!&/]*)/gi;const h=s.create({name:"link",priority:1e3,keepOnSplit:false,onCreate(){this.options.protocols.forEach((t=>{typeof t!=="string"?u(t.scheme,t.optionalSlashes):u(t)}))},onDestroy(){d()},inclusive(){return this.options.autolink},addOptions(){return{openOnClick:true,linkOnPaste:true,autolink:true,protocols:[],HTMLAttributes:{target:"_blank",rel:"noopener noreferrer nofollow",class:null},validate:void 0}},addAttributes(){return{href:{default:null},target:{default:this.options.HTMLAttributes.target},rel:{default:this.options.HTMLAttributes.rel},class:{default:this.options.HTMLAttributes.class}}},parseHTML(){return[{tag:'a[href]:not([href *= "javascript:" i])'}]},renderHTML({HTMLAttributes:t}){var e;return((e=t.href)===null||e===void 0?void 0:e.startsWith("javascript:"))?["a",i(this.options.HTMLAttributes,{...t,href:""}),0]:["a",i(this.options.HTMLAttributes,t),0]},addCommands(){return{setLink:t=>({chain:e})=>e().setMark(this.name,t).setMeta("preventAutolink",true).run(),toggleLink:t=>({chain:e})=>e().toggleMark(this.name,t,{extendEmptyMarkRange:true}).setMeta("preventAutolink",true).run(),unsetLink:()=>({chain:t})=>t().unsetMark(this.name,{extendEmptyMarkRange:true}).setMeta("preventAutolink",true).run()}},addPasteRules(){return[a({find:(t,e)=>{var n;const r=(n=e===null||e===void 0?void 0:e.clipboardData)===null||n===void 0?void 0:n.getData("text/html");const o=[];if(r){const t=(new DOMParser).parseFromString(r,"text/html");const e=t.querySelectorAll("a");e.length&&[...e].forEach((e=>o.push({text:e.innerText,data:{href:e.getAttribute("href")},index:t.body.innerText.indexOf(e.innerText)+e.innerText.length})))}if(t){const e=l(t).filter((t=>t.isLink));e.length&&e.forEach((t=>o.push({text:t.value,data:{href:t.href},index:t.start})))}return o},type:this.type,getAttributes:t=>{var e;return{href:(e=t.data)===null||e===void 0?void 0:e.href}}})]},addProseMirrorPlugins(){const t=[];this.options.autolink&&t.push(autolink({type:this.type,validate:this.options.validate}));this.options.openOnClick&&t.push(clickHandler({type:this.type}));this.options.linkOnPaste&&t.push(pasteHandler({editor:this.editor,type:this.type}));return t}});export{h as Link,h as default,f as pasteRegex};

